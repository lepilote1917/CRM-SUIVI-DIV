<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîí DIV CRM - Pipeline Conversion</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1d1d1f;
      overflow-x: hidden;
    }
    
    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    
    /* Header */
    .header {
      padding: 30px 40px;
      margin: 20px;
      border-radius: 20px;
    }
    
    .header h1 {
      font-size: 42px;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
      letter-spacing: -1px;
    }
    
    .header p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 18px;
      font-weight: 400;
    }
    
    /* Stats Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin: 20px;
      padding: 25px;
      border-radius: 20px;
    }
    
    .stat-item {
      text-align: center;
      padding: 20px;
      border-radius: 15px;
      transition: transform 0.2s;
    }
    
    .stat-item:hover {
      transform: translateY(-5px);
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }
    
    /* Pipeline Kanban */
    .pipeline {
      margin: 20px;
      padding: 30px;
      border-radius: 20px;
      min-height: 600px;
    }
    
    .pipeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .pipeline-header h2 {
      font-size: 28px;
      font-weight: 700;
      color: white;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      color: #667eea;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .kanban {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .kanban-column {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      min-height: 400px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .column-title {
      font-size: 16px;
      font-weight: 700;
      color: white;
    }
    
    .column-count {
      background: white;
      color: #667eea;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
    }
    
    .column-cards {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 300px;
    }
    
    .prospect-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      cursor: grab;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .prospect-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    
    .prospect-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }
    
    .card-title {
      font-size: 15px;
      font-weight: 700;
      color: #1d1d1f;
      margin-bottom: 4px;
    }
    
    .card-contact {
      font-size: 13px;
      color: #666;
    }
    
    .card-meta {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .card-badge {
      background: #f0f2f5;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      color: #667eea;
    }
    
    .card-price {
      font-size: 16px;
      font-weight: 700;
      color: #38ef7d;
      margin-top: 8px;
    }
    
    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .card-btn {
      flex: 1;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .card-btn-view {
      background: #667eea;
      color: white;
    }
    
    .card-btn-edit {
      background: #f0f2f5;
      color: #667eea;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .modal-header h3 {
      font-size: 24px;
      font-weight: 700;
      color: #1d1d1f;
    }
    
    .modal-close {
      font-size: 28px;
      color: #999;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .modal-close:hover {
      color: #333;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: #1d1d1f;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    /* Templates Modal */
    .template-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .template-item {
      background: #f9fafb;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .template-item:hover {
      background: #f0f2f5;
      transform: translateX(5px);
    }
    
    .template-title {
      font-size: 15px;
      font-weight: 700;
      color: #1d1d1f;
      margin-bottom: 5px;
    }
    
    .template-meta {
      font-size: 13px;
      color: #666;
    }
    
    .template-preview {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-family: 'SF Mono', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      border: 2px solid #e0e0e0;
    }
    
    /* Drag Over State */
    .kanban-column.drag-over {
      background: rgba(102, 126, 234, 0.2);
      border: 2px dashed white;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    
    .empty-state p {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header glass" style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1>üîí DIV CRM</h1>
      <p>Pipeline de Conversion ‚Äî D√©mo ‚Üí Client Payant</p>
    </div>
    <button id="lockBtn" style="padding: 12px 24px; background: rgba(255,92,122,.2); color: #fff; border: 2px solid rgba(255,92,122,.5); border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s; backdrop-filter: blur(10px);" onmouseover="this.style.transform='translateY(-2px)'; this.style.background='rgba(255,92,122,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.background='rgba(255,92,122,.2)'">
      üîí Verrouiller
    </button>
  </div>

  <!-- Stats -->
  <div class="stats-bar glass">
    <div class="stat-item glass-card">
      <div class="stat-value" id="stat-total">0</div>
      <div class="stat-label">Total Prospects</div>
    </div>
    <div class="stat-item glass-card">
      <div class="stat-value" id="stat-actifs">0</div>
      <div class="stat-label">En Conversion</div>
    </div>
    <div class="stat-item glass-card">
      <div class="stat-value" id="stat-signes">0</div>
      <div class="stat-label">Sign√©s</div>
    </div>
    <div class="stat-item glass-card">
      <div class="stat-value" id="stat-revenue">0‚Ç¨</div>
      <div class="stat-label">Revenue Sign√©</div>
    </div>
    <div class="stat-item glass-card">
      <div class="stat-value" id="stat-pipeline">0‚Ç¨</div>
      <div class="stat-label">Pipeline Actif</div>
    </div>
  </div>

  <!-- Pipeline Kanban -->
  <div class="pipeline glass">
    <div class="pipeline-header">
      <h2>üìä Pipeline Visuel</h2>
      <div>
        <button class="btn" onclick="showAddProspectModal()">+ Nouveau Prospect</button>
        <button class="btn" onclick="showTemplatesModal()" style="margin-left: 10px;">üìù Templates</button>
      </div>
    </div>
    
    <div class="kanban" id="kanban">
      <!-- Colonnes g√©n√©r√©es dynamiquement -->
    </div>
  </div>

  <!-- Modal Add/Edit Prospect -->
  <div id="prospect-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Nouveau Prospect</h3>
        <span class="modal-close" onclick="closeModal('prospect-modal')">&times;</span>
      </div>
      <form id="prospect-form" onsubmit="saveProspect(event)">
        <input type="hidden" id="prospect-id">
        
        <div class="form-group">
          <label>Cabinet *</label>
          <input type="text" id="nom_cabinet" required>
        </div>
        
        <div class="form-group">
          <label>Contact *</label>
          <input type="text" id="contact_nom" required placeholder="Nom complet">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>T√©l√©phone</label>
            <input type="tel" id="contact_tel" placeholder="+33 6 XX XX XX XX">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="contact_email" placeholder="contact@cabinet.fr">
          </div>
        </div>
        
        <div class="form-group">
          <label>LinkedIn</label>
          <input type="url" id="contact_linkedin" placeholder="https://linkedin.com/in/...">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Nb Clients Cabinet</label>
            <input type="number" id="nb_clients_cabinet" placeholder="50">
          </div>
          <div class="form-group">
            <label>Prix Discut√© (‚Ç¨)</label>
            <input type="number" id="prix_discute" placeholder="50000" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Stockage (Go)</label>
            <input type="number" id="stockage_go" placeholder="500">
          </div>
          <div class="form-group">
            <label>Date D√©mo *</label>
            <input type="date" id="date_demo" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>R√©sum√© D√©mo</label>
          <textarea id="resume_demo" placeholder="Points cl√©s de la d√©mo, besoins exprim√©s, objections..."></textarea>
        </div>
        
        <div class="form-group">
          <label>Notes</label>
          <textarea id="notes" placeholder="Notes compl√©mentaires..."></textarea>
        </div>
        
        <button type="submit" class="btn-primary">Enregistrer</button>
      </form>
    </div>
  </div>

  <!-- Modal Detail Prospect -->
  <div id="detail-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="detail-title"></h3>
        <span class="modal-close" onclick="closeModal('detail-modal')">&times;</span>
      </div>
      <div id="detail-content"></div>
    </div>
  </div>

  <!-- Modal Templates -->
  <div id="templates-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>üìù Templates de Relances</h3>
        <span class="modal-close" onclick="closeModal('templates-modal')">&times;</span>
      </div>
      <div class="template-list" id="template-list"></div>
    </div>
  </div>

  <script>
    const API = '/api';
    
    const ETAPES = [
      { id: 'demo_faite', label: 'D√©mo Faite', color: '#667eea' },
      { id: 'relance_1', label: 'Relance 1', color: '#f093fb' },
      { id: 'relance_2', label: 'Relance 2', color: '#4facfe' },
      { id: 'relance_3', label: 'Relance 3', color: '#43e97b' },
      { id: 'relance_4', label: 'Relance 4', color: '#fa709a' },
      { id: 'relance_5', label: 'Relance 5', color: '#fee140' },
      { id: 'signe', label: '‚úÖ Sign√©', color: '#38ef7d' },
      { id: 'perdu', label: '‚ùå Perdu', color: '#ff6b6b' }
    ];
    
    let prospects = [];
    let draggedCard = null;
    
    // Init
    async function init() {
      await loadStats();
      await loadProspects();
      renderKanban();
    }
    
    // Stats
    async function loadStats() {
      const res = await fetch(`${API}/stats`);
      const stats = await res.json();
      
      document.getElementById('stat-total').textContent = stats.total || 0;
      const actifs = (stats.total || 0) - (stats.signe || 0) - (stats.perdu || 0);
      document.getElementById('stat-actifs').textContent = actifs;
      document.getElementById('stat-signes').textContent = stats.signe || 0;
      document.getElementById('stat-revenue').textContent = formatPrice(stats.revenue_signe || 0);
      document.getElementById('stat-pipeline').textContent = formatPrice(stats.pipeline_actif || 0);
    }
    
    // Prospects
    async function loadProspects() {
      const res = await fetch(`${API}/prospects`);
      prospects = await res.json();
    }
    
    // Render Kanban
    function renderKanban() {
      const kanban = document.getElementById('kanban');
      kanban.innerHTML = '';
      
      ETAPES.forEach(etape => {
        const prospectsEtape = prospects.filter(p => p.etape === etape.id);
        
        const column = document.createElement('div');
        column.className = 'kanban-column';
        column.dataset.etape = etape.id;
        column.ondrop = handleDrop;
        column.ondragover = handleDragOver;
        column.ondragleave = handleDragLeave;
        
        column.innerHTML = `
          <div class="column-header">
            <div class="column-title">${etape.label}</div>
            <div class="column-count">${prospectsEtape.length}</div>
          </div>
          <div class="column-cards" data-etape="${etape.id}">
            ${prospectsEtape.length === 0 && etape.id === 'demo_faite' 
              ? '<div class="empty-state"><h3>Aucun prospect</h3><p>Ajoute ton premier prospect d√©mo</p></div>' 
              : ''}
          </div>
        `;
        
        const cardsContainer = column.querySelector('.column-cards');
        prospectsEtape.forEach(p => {
          cardsContainer.appendChild(createProspectCard(p));
        });
        
        kanban.appendChild(column);
      });
    }
    
    // Create Card
    function createProspectCard(p) {
      const card = document.createElement('div');
      card.className = 'prospect-card';
      card.draggable = true;
      card.dataset.id = p.id;
      card.ondragstart = handleDragStart;
      card.ondragend = handleDragEnd;
      
      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">${p.nom_cabinet}</div>
            <div class="card-contact">${p.contact_nom}</div>
          </div>
        </div>
        <div class="card-meta">
          ${p.nb_clients_cabinet ? `<span class="card-badge">${p.nb_clients_cabinet} clients</span>` : ''}
          ${p.stockage_go ? `<span class="card-badge">${p.stockage_go} Go</span>` : ''}
          <span class="card-badge">${p.date_demo}</span>
        </div>
        <div class="card-price">${formatPrice(p.prix_discute || 0)}</div>
        <div class="card-actions">
          <button class="card-btn card-btn-view" onclick="showProspectDetail(${p.id})">D√©tails</button>
          <button class="card-btn card-btn-edit" onclick="editProspect(${p.id})">Modifier</button>
        </div>
      `;
      
      return card;
    }
    
    // Drag & Drop
    function handleDragStart(e) {
      draggedCard = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drag-over'));
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const column = e.target.closest('.kanban-column');
      if (column) column.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      const column = e.target.closest('.kanban-column');
      if (column) column.classList.remove('drag-over');
    }
    
    async function handleDrop(e) {
      e.preventDefault();
      const column = e.target.closest('.kanban-column');
      if (!column || !draggedCard) return;
      
      column.classList.remove('drag-over');
      
      const newEtape = column.dataset.etape;
      const prospectId = draggedCard.dataset.id;
      
      // Update DB
      await fetch(`${API}/prospects/${prospectId}/etape`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ etape: newEtape })
      });
      
      // Refresh
      await loadProspects();
      await loadStats();
      renderKanban();
    }
    
    // Modals
    function showAddProspectModal() {
      document.getElementById('modal-title').textContent = 'Nouveau Prospect';
      document.getElementById('prospect-form').reset();
      document.getElementById('prospect-id').value = '';
      document.getElementById('prospect-modal').classList.add('show');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }
    
    async function saveProspect(e) {
      e.preventDefault();
      const id = document.getElementById('prospect-id').value;
      const data = {
        nom_cabinet: document.getElementById('nom_cabinet').value,
        contact_nom: document.getElementById('contact_nom').value,
        contact_tel: document.getElementById('contact_tel').value,
        contact_email: document.getElementById('contact_email').value,
        contact_linkedin: document.getElementById('contact_linkedin').value,
        nb_clients_cabinet: parseInt(document.getElementById('nb_clients_cabinet').value) || null,
        prix_discute: parseInt(document.getElementById('prix_discute').value) || 0,
        stockage_go: parseInt(document.getElementById('stockage_go').value) || null,
        date_demo: document.getElementById('date_demo').value,
        resume_demo: document.getElementById('resume_demo').value,
        etape: 'demo_faite',
        notes: document.getElementById('notes').value
      };
      
      const url = id ? `${API}/prospects/${id}` : `${API}/prospects`;
      const method = id ? 'PUT' : 'POST';
      
      await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      closeModal('prospect-modal');
      await loadProspects();
      await loadStats();
      renderKanban();
    }
    
    async function editProspect(id) {
      const res = await fetch(`${API}/prospects/${id}`);
      const data = await res.json();
      const p = data.prospect;
      
      document.getElementById('modal-title').textContent = 'Modifier Prospect';
      document.getElementById('prospect-id').value = p.id;
      document.getElementById('nom_cabinet').value = p.nom_cabinet;
      document.getElementById('contact_nom').value = p.contact_nom;
      document.getElementById('contact_tel').value = p.contact_tel || '';
      document.getElementById('contact_email').value = p.contact_email || '';
      document.getElementById('contact_linkedin').value = p.contact_linkedin || '';
      document.getElementById('nb_clients_cabinet').value = p.nb_clients_cabinet || '';
      document.getElementById('prix_discute').value = p.prix_discute;
      document.getElementById('stockage_go').value = p.stockage_go || '';
      document.getElementById('date_demo').value = p.date_demo;
      document.getElementById('resume_demo').value = p.resume_demo || '';
      document.getElementById('notes').value = p.notes || '';
      
      document.getElementById('prospect-modal').classList.add('show');
    }
    
    async function showProspectDetail(id) {
      const res = await fetch(`${API}/prospects/${id}`);
      const data = await res.json();
      const p = data.prospect;
      
      document.getElementById('detail-title').textContent = p.nom_cabinet;
      document.getElementById('detail-content').innerHTML = `
        <div style="line-height: 1.8;">
          <h4 style="margin-bottom: 10px;">Contact</h4>
          <p><strong>${p.contact_nom}</strong><br>
          ${p.contact_email || 'N/A'}<br>
          ${p.contact_tel || 'N/A'}<br>
          ${p.contact_linkedin ? `<a href="${p.contact_linkedin}" target="_blank" style="color: #667eea;">LinkedIn ‚Üí</a>` : ''}</p>
          
          <h4 style="margin-top: 20px; margin-bottom: 10px;">Informations</h4>
          <p>Clients cabinet: ${p.nb_clients_cabinet || 'N/A'}<br>
          Prix discut√©: ${formatPrice(p.prix_discute)}<br>
          Stockage: ${p.stockage_go ? p.stockage_go + ' Go' : 'N/A'}<br>
          Date d√©mo: ${p.date_demo}</p>
          
          ${p.resume_demo ? `<h4 style="margin-top: 20px; margin-bottom: 10px;">R√©sum√© D√©mo</h4><p style="background: #f9fafb; padding: 15px; border-radius: 10px;">${p.resume_demo}</p>` : ''}
          
          ${p.notes ? `<h4 style="margin-top: 20px; margin-bottom: 10px;">Notes</h4><p style="background: #f9fafb; padding: 15px; border-radius: 10px;">${p.notes}</p>` : ''}
          
          <h4 style="margin-top: 20px; margin-bottom: 10px;">√âtape actuelle</h4>
          <p><strong>${ETAPES.find(e => e.id === p.etape).label}</strong></p>
        </div>
      `;
      
      document.getElementById('detail-modal').classList.add('show');
    }
    
    async function showTemplatesModal() {
      const res = await fetch(`${API}/templates`);
      const templates = await res.json();
      
      const list = document.getElementById('template-list');
      list.innerHTML = Object.keys(templates).map(key => {
        const t = templates[key];
        return `
          <div class="template-item" onclick="showTemplatePreview('${key}')">
            <div class="template-title">${key}</div>
            <div class="template-meta">Canal: ${t.canal} ${t.delai ? `‚Ä¢ ${t.delai}` : ''}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('templates-modal').classList.add('show');
    }
    
    async function showTemplatePreview(key) {
      const res = await fetch(`${API}/templates`);
      const templates = await res.json();
      const t = templates[key];
      
      alert(`Template: ${key}\n\nCanal: ${t.canal}\n${t.delai ? 'D√©lai: ' + t.delai + '\n' : ''}${t.sujet ? 'Sujet: ' + t.sujet + '\n\n' : '\n'}${t.corps || t.notes_appel}`);
    }
    
    // Utils
    function formatPrice(price) {
      return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(price);
    }
    
    // Bouton de verrouillage
    document.getElementById('lockBtn').onclick = async () => {
      if(!confirm('üîí Verrouiller la session ?\n\nToutes les donn√©es sont sauvegard√©es automatiquement.\nTu devras te reconnecter apr√®s.')) return;
      
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (err) {
        alert('Erreur lors de la d√©connexion');
      }
    };
    
    // Init on load
    init();
  </script>
</body>
</html>
